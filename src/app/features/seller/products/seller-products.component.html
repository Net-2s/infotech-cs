<app-header></app-header>

<main class="seller-products">
  <div class="container">
    <div class="page-header">
      <h1>üì¶ Mes Produits</h1>
      <button class="btn btn-primary" (click)="openAddModal()">
        <svg viewBox="0 0 24 24" fill="none" width="20" height="20">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Ajouter un produit
      </button>
    </div>

    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Chargement de vos produits...</p>
      </div>
    } @else {
      @if (listings().length === 0) {
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <h2>Aucun produit</h2>
          <p>Commencez par ajouter votre premier produit √† vendre</p>
          <button class="btn btn-primary" (click)="openAddModal()">Ajouter un produit</button>
        </div>
      } @else {
        <div class="products-grid">
          @for (listing of listings(); track listing.id) {
            <div class="product-card">
              <div class="product-image">
                @if (listing.images.length > 0) {
                  <img [src]="listing.images[0]" [alt]="listing.productTitle">
                } @else {
                  <div class="image-placeholder">üì¶</div>
                }
                <span class="product-status" [class.active]="listing.active">
                  {{ listing.active ? 'Actif' : 'Inactif' }}
                </span>
              </div>

              <div class="product-info">
                <h3>{{ listing.productTitle }}</h3>
                <p class="product-brand">{{ listing.productBrand }} - {{ listing.productTitle.split(' ')[listing.productTitle.split(' ').length - 1] }}</p>
                
                <div class="product-details">
                  <div class="detail-item">
                    <span class="label">Prix:</span>
                    <span class="value price">{{ listing.price | number: '1.2-2' }} ‚Ç¨</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">Stock:</span>
                    <span class="value">{{ listing.quantity }} unit√©(s)</span>
                  </div>
                  @if (listing.conditionNote) {
                    <div class="detail-item condition-note">
                      <span class="label">Note:</span>
                      <span class="value">{{ listing.conditionNote }}</span>
                    </div>
                  }
                </div>

                <div class="product-actions">
                  <button class="btn btn-secondary btn-sm">
                    <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Modifier
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="deleteListing(listing.id)">
                    <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
                      <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Supprimer
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      }
    }
  </div>
</main>

<!-- Modal Ajout Produit -->
@if (showAddModal()) {
  <div class="modal-overlay" (click)="closeAddModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üÜï Ajouter un nouveau produit</h2>
        <button class="close-btn" (click)="closeAddModal()">√ó</button>
      </div>

      <form class="modal-body" (ngSubmit)="createProduct()">
        <!-- Choix du mode de cr√©ation -->
        <div class="form-section mode-selection">
          <h3>üéØ Type d'ajout</h3>
          <div class="mode-buttons">
            <button 
              type="button"
              class="mode-btn"
              [class.active]="creationMode === 'new'"
              (click)="setCreationMode('new')">
              <div class="mode-icon">üÜï</div>
              <div class="mode-content">
                <strong>Nouveau produit</strong>
                <span>Cr√©er un produit qui n'existe pas encore dans le catalogue</span>
              </div>
            </button>
            
            <button 
              type="button"
              class="mode-btn"
              [class.active]="creationMode === 'existing'"
              (click)="setCreationMode('existing')">
              <div class="mode-icon">üîç</div>
              <div class="mode-content">
                <strong>Produit existant</strong>
                <span>Vendre un produit d√©j√† pr√©sent dans le catalogue</span>
              </div>
            </button>
          </div>
        </div>

        <!-- MODE: Produit existant -->
        @if (creationMode === 'existing') {
          <div class="form-section">
            <h3>üîé Rechercher un produit</h3>
            
            <div class="search-box">
              <input 
                type="text"
                class="form-input search-input"
                [(ngModel)]="searchQuery"
                name="searchQuery"
                (input)="searchExistingProducts()"
                placeholder="Rechercher par titre, marque, mod√®le...">
              
              @if (isSearching()) {
                <div class="search-spinner"></div>
              }
            </div>

            <!-- R√©sultats de recherche -->
            @if (searchResults().length > 0) {
              <div class="search-results">
                <p class="results-count">{{ searchResults().length }} produit(s) trouv√©(s)</p>
                <div class="results-list">
                  @for (product of searchResults(); track product.id) {
                    <div 
                      class="result-item"
                      [class.selected]="selectedExistingProduct?.id === product.id"
                      (click)="selectExistingProduct(product)">
                      <div class="result-image">
                        @if (product.images && product.images.length > 0) {
                          <img [src]="product.images[0]" [alt]="product.title">
                        } @else {
                          <div class="image-placeholder">üì¶</div>
                        }
                      </div>
                      <div class="result-info">
                        <h4>{{ product.title }}</h4>
                        <p class="result-meta">{{ product.brand }} - {{ product.model }}</p>
                        <span class="result-badge">{{ product.condition }}</span>
                      </div>
                      @if (selectedExistingProduct?.id === product.id) {
                        <div class="selected-check">‚úì</div>
                      }
                    </div>
                  }
                </div>
              </div>
            } @else if (searchQuery && !isSearching()) {
              <div class="no-results">
                <p>üòï Aucun produit trouv√© pour "{{ searchQuery }}"</p>
                <p class="hint">Essayez avec d'autres mots-cl√©s ou cr√©ez un nouveau produit</p>
              </div>
            }

            <!-- Produit s√©lectionn√© -->
            @if (selectedExistingProduct) {
              <div class="selected-product-card">
                <div class="card-header">
                  <h4>‚úì Produit s√©lectionn√©</h4>
                  <button type="button" class="btn-text" (click)="selectedExistingProduct = null">Changer</button>
                </div>
                <div class="product-preview">
                  <div class="preview-image">
                    @if (selectedExistingProduct.images && selectedExistingProduct.images.length > 0) {
                      <img [src]="selectedExistingProduct.images[0]" [alt]="selectedExistingProduct.title">
                    } @else {
                      <div class="image-placeholder">üì¶</div>
                    }
                  </div>
                  <div class="preview-info">
                    <h4>{{ selectedExistingProduct.title }}</h4>
                    <p><strong>Marque:</strong> {{ selectedExistingProduct.brand }}</p>
                    <p><strong>Mod√®le:</strong> {{ selectedExistingProduct.model }}</p>
                    <p><strong>√âtat:</strong> {{ selectedExistingProduct.condition }}</p>
                  </div>
                </div>
              </div>
            }
          </div>
        }

        <!-- MODE: Nouveau produit -->
        @if (creationMode === 'new') {
          <!-- Informations produit -->
          <div class="form-section">
            <h3>üìã Informations du produit</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Titre du produit *</label>
              <input 
                type="text" 
                class="form-input" 
                [(ngModel)]="newProduct.title"
                name="title"
                placeholder="Ex: iPhone 13 Pro 128GB"
                required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Marque *</label>
              <input 
                type="text" 
                class="form-input" 
                [(ngModel)]="newProduct.brand"
                name="brand"
                placeholder="Ex: Apple"
                required>
            </div>

            <div class="form-group">
              <label>Mod√®le *</label>
              <input 
                type="text" 
                class="form-input" 
                [(ngModel)]="newProduct.model"
                name="model"
                placeholder="Ex: iPhone 13 Pro"
                required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Cat√©gorie</label>
              <select class="form-input" [(ngModel)]="newProduct.categoryId" name="categoryId">
                <option [value]="null">-- S√©lectionner une cat√©gorie --</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label>√âtat *</label>
              <select class="form-input" [(ngModel)]="newProduct.condition" name="condition" required>
                @for (condition of conditions; track condition) {
                  <option [value]="condition">{{ condition }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Prix (‚Ç¨) *</label>
              <input 
                type="number" 
                class="form-input" 
                [(ngModel)]="newProduct.price"
                name="price"
                placeholder="0.00"
                step="0.01"
                min="0"
                required>
            </div>

            <div class="form-group">
              <label>Quantit√© *</label>
              <input 
                type="number" 
                class="form-input" 
                [(ngModel)]="newProduct.quantity"
                name="quantity"
                placeholder="1"
                min="1"
                required>
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea 
              class="form-input" 
              rows="4"
              [(ngModel)]="newProduct.description"
              name="description"
              placeholder="D√©crivez votre produit en d√©tail..."></textarea>
          </div>

          <div class="form-group">
            <label>Note sur l'√©tat</label>
            <textarea 
              class="form-input" 
              rows="2"
              [(ngModel)]="newProduct.conditionNote"
              name="conditionNote"
              placeholder="Ex: L√©g√®res traces d'usage, √©cran impeccable..."></textarea>
          </div>
        </div>
      }

      <!-- Section prix et stock (commune aux deux modes) -->
        <div class="form-section">
          <h3>üí∞ Votre offre de vente</h3>
          <p class="section-help">D√©finissez le prix et la quantit√© disponible pour votre offre</p>
          
          <div class="form-row">
            <div class="form-group">
              <label>Prix de vente (‚Ç¨) *</label>
              <input 
                type="number" 
                class="form-input" 
                [(ngModel)]="newProduct.price"
                name="price"
                placeholder="0.00"
                step="0.01"
                min="0"
                required>
            </div>

            <div class="form-group">
              <label>Quantit√© en stock *</label>
              <input 
                type="number" 
                class="form-input" 
                [(ngModel)]="newProduct.quantity"
                name="quantity"
                placeholder="1"
                min="1"
                required>
            </div>
          </div>

          <div class="form-group">
            <label>Note sur l'√©tat de votre produit</label>
            <textarea 
              class="form-input" 
              rows="2"
              [(ngModel)]="newProduct.conditionNote"
              name="conditionNote"
              placeholder="Ex: L√©g√®res traces d'usage, √©cran impeccable, emballage d'origine..."></textarea>
          </div>
        </div>

        <!-- Passeport Num√©rique (uniquement pour nouveau produit) -->
        @if (creationMode === 'new') {
          <div class="form-section passport-section">
            <div class="section-header-toggle">
              <div>
                <h3>üåç Passeport Num√©rique (Optionnel)</h3>
                <p class="section-help">Ajoutez des informations sur l'empreinte √©cologique et la durabilit√© de votre produit</p>
              </div>
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  [checked]="addDigitalPassport()"
                  (change)="addDigitalPassport.set(!addDigitalPassport())">
                <span class="toggle-slider"></span>
              </label>
            </div>

            @if (addDigitalPassport()) {
              <div class="passport-form">
                <!-- Empreinte Carbone -->
                <div class="passport-subsection">
                  <h4>üå°Ô∏è Empreinte Carbone</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Score Carbone</label>
                      <select 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.carbonScore"
                        name="carbonScore">
                        @for (score of carbonScores; track score) {
                          <option [value]="score">{{ score }}</option>
                        }
                      </select>
                    </div>
                    <div class="form-group">
                      <label>√âmissions totales (kg CO‚ÇÇ)</label>
                      <input 
                        type="number" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.totalEmissions"
                        name="totalEmissions"
                        step="0.1">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Fabrication (kg CO‚ÇÇ)</label>
                      <input 
                        type="number" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.manufacturing"
                        name="manufacturing"
                        step="0.1">
                    </div>
                    <div class="form-group">
                      <label>Transport (kg CO‚ÇÇ)</label>
                      <input 
                        type="number" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.transport"
                        name="transport"
                        step="0.1">
                    </div>
                  </div>
                </div>

                <!-- Tra√ßabilit√© -->
                <div class="passport-subsection">
                  <h4>üìç Tra√ßabilit√©</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Pays d'origine</label>
                      <input 
                        type="text" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.origin"
                        name="origin"
                        placeholder="Ex: France">
                    </div>
                    <div class="form-group">
                      <label>Fabricant</label>
                      <input 
                        type="text" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.manufacturer"
                        name="manufacturer"
                        placeholder="Ex: Apple Inc.">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Date de fabrication</label>
                    <input 
                      type="date" 
                      class="form-input" 
                      [(ngModel)]="digitalPassportData.manufacturingDate"
                      name="manufacturingDate">
                  </div>
                </div>

                <!-- Mat√©riaux -->
                <div class="passport-subsection">
                  <h4>‚ôªÔ∏è Mat√©riaux</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Mat√©riaux renouvelables (%)</label>
                      <input 
                        type="number" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.renewableMaterials"
                        name="renewableMaterials"
                        min="0"
                        max="100">
                    </div>
                    <div class="form-group">
                      <label>Mat√©riaux recycl√©s (%)</label>
                      <input 
                        type="number" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.recycledMaterials"
                        name="recycledMaterials"
                        min="0"
                        max="100">
                    </div>
                  </div>
                </div>

                <!-- Durabilit√© -->
                <div class="passport-subsection">
                  <h4>üîß Durabilit√©</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Score de r√©parabilit√© (/10)</label>
                      <input 
                        type="number" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.repairabilityScore"
                        name="repairabilityScore"
                        min="0"
                        max="10"
                        step="0.1">
                    </div>
                    <div class="form-group">
                      <label>Garantie (mois)</label>
                      <input 
                        type="number" 
                        class="form-input" 
                        [(ngModel)]="digitalPassportData.warranty"
                        name="warranty"
                        min="0">
                    </div>
                  </div>
                </div>

                <!-- Certifications -->
                <div class="passport-subsection">
                  <h4>üèÜ Certifications</h4>
                  <div class="form-group">
                    <label>Certifications (s√©par√©es par virgule)</label>
                    <input 
                      type="text" 
                      class="form-input" 
                      [(ngModel)]="digitalPassportData.certifications"
                      name="certifications"
                      placeholder="Ex: CE, RoHS, Energy Star">
                    <small class="form-hint">Exemples: CE, RoHS, Energy Star, ISO 14001, Fair Trade, Bio</small>
                  </div>
                </div>
              </div>
            }
          </div>
        }

        <!-- Upload d'images (uniquement pour nouveau produit) -->
        @if (creationMode === 'new') {
          <div class="form-section">
            <h3>üì∏ Images du produit *</h3>
            <p class="section-help">Ajoutez des photos de votre produit (formats: JPG, PNG, WebP, GIF - max 10MB par image)</p>

          <!-- Zone de drop -->
          <div 
            class="image-upload-zone"
            (drop)="onDrop($event)"
            (dragover)="onDragOver($event)">
            <input 
              type="file" 
              id="fileInput"
              class="file-input"
              accept="image/jpeg,image/png,image/webp,image/gif"
              multiple
              (change)="onFilesSelected($event)">
            
            <label for="fileInput" class="upload-label">
              <div class="upload-icon">üì§</div>
              <p class="upload-text">Cliquez pour s√©lectionner ou glissez-d√©posez vos images</p>
              <p class="upload-hint">Vous pouvez ajouter plusieurs images</p>
            </label>
          </div>

          <!-- Aper√ßu des images -->
          @if (imagePreviews.length > 0) {
            <div class="image-previews">
              <h4>Aper√ßu ({{ imagePreviews.length }} image(s))</h4>
              <div class="previews-grid">
                @for (preview of imagePreviews; track $index) {
                  <div class="preview-item">
                    <img [src]="preview" alt="Aper√ßu">
                    <button 
                      type="button" 
                      class="remove-image-btn"
                      (click)="removeImage($index)">
                      <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    </button>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
      </form>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddModal()" [disabled]="isUploading()">
          Annuler
        </button>
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="createProduct()" 
          [disabled]="isUploading() || (creationMode === 'existing' && !selectedExistingProduct)">
          @if (isUploading()) {
            <span class="btn-spinner"></span>
            Cr√©ation en cours...
          } @else {
            @if (creationMode === 'new') {
              ‚úì Cr√©er le produit
            } @else {
              ‚úì Ajouter mon offre
            }
          }
        </button>
      </div>
    </div>
  </div>
}

<app-footer></app-footer>
