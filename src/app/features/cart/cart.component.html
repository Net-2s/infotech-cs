<app-header></app-header>

<main class="cart-page">
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Détails de votre panier</h1>
      @if (cartService.cartSummary().itemCount > 0) {
        <button class="btn btn-ghost" (click)="clearCart()">Vider le panier</button>
      }
    </div>

    @if (cartService.cartSummary().items.length === 0) {
      <div class="empty-cart">
        <svg class="empty-icon" viewBox="0 0 24 24" fill="none">
          <path d="M9 2L7 6M17 6L15 2M3 6h18M18.74 6l-1.89 12.36A2 2 0 0 1 14.88 20H9.12a2 2 0 0 1-1.97-1.64L5.26 6" stroke="currentColor" stroke-width="2"/>
        </svg>
        <h2>Votre panier est vide</h2>
        <p>Commencez vos achats dès maintenant</p>
        <a routerLink="/products" class="btn btn-primary btn-lg">
          Découvrir les produits
        </a>
      </div>
    } @else {
      <div class="cart-content">
        <div class="cart-items">
          @for (item of cartService.cartSummary().items; track item.id) {
            <div class="cart-item-card">
              <!-- Badge meilleur prix -->
              <div class="item-badges">
                <span class="badge badge-price">Meilleur prix en 7 jours</span>
              </div>

              <!-- Contenu principal de l'article -->
              <div class="item-main">
                <div class="item-image">
                  @if (item.productImage) {
                    <img [src]="item.productImage" [alt]="item.productTitle">
                  } @else {
                    <div class="image-placeholder">
                      <svg viewBox="0 0 24 24" fill="none">
                        <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    </div>
                  }
                </div>

                <div class="item-details">
                  <h3 class="item-title">{{ item.productTitle }}</h3>
                  
                  @if (item.conditionNote) {
                    <span class="item-condition">{{ item.conditionNote }}</span>
                  }

                  <div class="item-delivery">
                    @if (item.estimatedDeliveryMin && item.estimatedDeliveryMax) {
                      <p class="delivery-standard">
                        <svg viewBox="0 0 24 24" fill="none" class="delivery-icon">
                          <path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11M14 18H9M5 18a2 2 0 1 0 4 0 2 2 0 0 0-4 0z" stroke="currentColor" stroke-width="1.5"/>
                          <path d="M14 7h4l3 3v7c0 .6-.4 1-1 1h-1M14 7v11M15 18a2 2 0 1 0 4 0 2 2 0 0 0-4 0z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        Livraison entre le {{ item.estimatedDeliveryMin }} et le {{ item.estimatedDeliveryMax }} · <span class="free">Offerte</span>
                      </p>
                    }
                    @if (item.expressDeliveryAvailable && item.expressDeliveryDate) {
                      <p class="delivery-express">
                        Livraison Express entre le {{ item.expressDeliveryDate }} · à partir de {{ item.expressDeliveryPrice | currency:'EUR':'symbol':'1.2-2':'fr' }}
                      </p>
                    }
                  </div>
                </div>

                <div class="item-price-section">
                  <div class="item-price">{{ item.price | currency:'EUR':'symbol':'1.2-2':'fr' }}</div>
                  
                  <div class="item-quantity-actions">
                    <select class="quantity-select" [value]="item.quantity" (change)="onQuantityChange(item.id, $event)">
                      @for (q of [1,2,3,4,5,6,7,8,9,10]; track q) {
                        <option [value]="q" [selected]="item.quantity === q">{{ q }}</option>
                      }
                    </select>
                    <button class="btn-remove" (click)="removeItem(item.id)">Supprimer</button>
                  </div>
                </div>
              </div>

              <!-- Section assurance -->
              <div class="insurance-section">
                <p class="insurance-intro">
                  La vie est pleine d'imprévus. Évitez les frais de réparation inattendus sur votre <strong>{{ item.productBrand || item.productTitle }}</strong>.
                </p>

                <div class="insurance-options">
                  @for (option of cartService.insuranceOptions; track option.id) {
                    <div 
                      class="insurance-card" 
                      [class.selected]="item.insurance?.optionId === option.id"
                      (click)="selectInsurance(item.id, option)">
                      
                      @if (option.recommended) {
                        <span class="insurance-badge">Recommandé</span>
                      }

                      <div class="insurance-header">
                        <div class="insurance-radio">
                          <span class="radio-circle" [class.active]="item.insurance?.optionId === option.id"></span>
                        </div>
                        <div class="insurance-title-section">
                          <h4 class="insurance-name">{{ option.name }}</h4>
                          <div class="insurance-price">
                            @if (option.pricePerMonth) {
                              <span class="price-monthly">{{ option.pricePerMonth | currency:'EUR':'symbol':'1.2-2':'fr' }} /mois</span>
                              <span class="price-detail">pour au moins {{ option.duration }} ({{ option.price | currency:'EUR':'symbol':'1.2-2':'fr' }})</span>
                            } @else {
                              <span class="price-annual">{{ option.price | currency:'EUR':'symbol':'1.2-2':'fr' }}</span>
                            }
                          </div>
                        </div>
                      </div>

                      <ul class="insurance-benefits">
                        @for (benefit of option.benefits; track benefit) {
                          <li>
                            <svg class="check-icon" viewBox="0 0 24 24" fill="none">
                              <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            {{ benefit }}
                          </li>
                        }
                      </ul>
                    </div>
                  }
                </div>

                <div class="insurance-footer">
                  <span class="insurance-provider">Assuré par <strong>BackUp</strong></span>
                  <a href="#" class="insurance-link">En savoir plus</a>
                </div>

                @if (item.insurance) {
                  <button class="btn-remove-insurance" (click)="removeInsurance(item.id, $event)">
                    <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
                      <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Retirer l'assurance
                  </button>
                }
              </div>
            </div>
          }
        </div>

        <div class="cart-summary">
          <h2 class="summary-title">Récapitulatif</h2>
          
          <div class="summary-row">
            <span>Sous-total ({{ cartService.cartSummary().itemCount }} article{{ cartService.cartSummary().itemCount > 1 ? 's' : '' }})</span>
            <span>{{ cartService.cartSummary().subtotal | currency:'EUR':'symbol':'1.2-2':'fr' }}</span>
          </div>

          @if (cartService.cartSummary().insuranceTotal > 0) {
            <div class="summary-row">
              <span>Assurance</span>
              <span>{{ cartService.cartSummary().insuranceTotal | currency:'EUR':'symbol':'1.2-2':'fr' }}</span>
            </div>
          }

          <div class="summary-row">
            <span>Livraison</span>
            <span class="text-success">Gratuite</span>
          </div>

          <hr class="summary-divider">

          <div class="summary-row summary-total">
            <span>Total</span>
            <span>{{ cartService.cartSummary().total | currency:'EUR':'symbol':'1.2-2':'fr' }}</span>
          </div>

          @if (cartService.cartSummary().insuranceTotal > 0) {
            <p class="summary-insurance-note">
              <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/>
              </svg>
              Dont {{ cartService.cartSummary().insuranceTotal | currency:'EUR':'symbol':'1.2-2':'fr' }} d'assurance
            </p>
          }

          <button class="btn btn-primary btn-lg w-full" (click)="proceedToCheckout()">
            Passer la commande
          </button>

          <a routerLink="/products" class="continue-shopping">
            Continuer mes achats
          </a>
        </div>
      </div>
    }
  </div>
</main>

<app-footer></app-footer>
